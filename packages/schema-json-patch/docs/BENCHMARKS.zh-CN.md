# 性能基准测试

`@waveox/schema-json-patch` 详细性能基准测试报告。

## 概览

| 功能                        | 场景             | 性能               |
| --------------------------- | ---------------- | ------------------ |
| **generatePatches**         | 10 项, 少量变更  | ~11,000 ops/sec    |
| **generatePatches**         | 100 项, 20% 变更 | ~1,500 ops/sec     |
| **generatePatches**         | 500 项, 10% 变更 | ~332 ops/sec       |
| **generatePatchesFromData** | 500 项, 10% 变更 | ~1,512 ops/sec     |
| **applyPatches**            | 10 项, 少量补丁  | ~29,173 ops/sec    |
| **applyPatches**            | 100 项, 稀疏补丁 | ~3,089 ops/sec     |
| **detectConflicts**         | 2 组, 少量冲突   | ~10,949 ops/sec    |
| **detectConflicts**         | 5 组, 有冲突     | ~5,825 ops/sec     |
| **resolveConflicts**        | 3 个冲突         | ~652,499 ops/sec   |
| **resolveConflicts**        | 10 个冲突        | ~274,235 ops/sec   |
| **validatePatches**         | 10 个补丁        | ~2,487,973 ops/sec |
| **validateJson**            | 100 项           | ~6,657 ops/sec     |

> [!TIP] > `generatePatchesFromData` 是新增的高性能 API，当数据已解析时可跳过 JSON.parse，性能提升 **4.5x**。

---

## 详细结果

### 补丁生成 (`generatePatches` / `generatePatchesFromData`)

| 数据规模   | 场景     | ops/sec | 平均耗时 (ms) |
| ---------- | -------- | ------- | ------------- |
| 小 (10项)  | 少量变更 | 11,000  | 0.09          |
| 小 (10项)  | 全部修改 | 7,200   | 0.14          |
| 中 (100项) | 稀疏 20% | 1,500   | 0.67          |
| 中 (100项) | 密集 50% | 1,200   | 0.83          |
| 大 (500项) | 稀疏 10% | 332     | 3.01          |
| 大 (500项) | 全量     | 182     | 5.48          |

**高性能 API `generatePatchesFromData` (500项):**

| 场景     | ops/sec | 平均耗时 (ms) | vs generatePatches |
| -------- | ------- | ------------- | ------------------ |
| 稀疏 10% | 1,512   | 0.66          | **4.5x 更快**      |
| 全量     | 303     | 3.29          | **1.7x 更快**      |

**顺序变化 (100项):**

| 场景     | ops/sec | 平均耗时 (ms) |
| -------- | ------- | ------------- |
| 完全打乱 | 1,350   | 0.74          |
| 反转顺序 | 1,400   | 0.71          |
| 部分重排 | 1,600   | 0.62          |

---

### 补丁应用 (`applyPatches`)

| 数据规模   | 场景        | ops/sec | 平均耗时 (ms) |
| ---------- | ----------- | ------- | ------------- |
| 小 (10项)  | 少量补丁    | 29,173  | 0.03          |
| 中 (100项) | 稀疏 (20处) | 3,089   | 0.32          |
| 中 (100项) | 密集 (全部) | 1,796   | 0.56          |
| 大 (500项) | 50 个补丁   | 601     | 1.66          |

**复杂操作 (100项):**

| 场景       | ops/sec | 平均耗时 (ms) |
| ---------- | ------- | ------------- |
| 添加 20 项 | 3,037   | 0.33          |
| 删除 20 项 | 2,027   | 0.49          |
| 混合操作   | 1,258   | 0.79          |

---

### 冲突检测 (`detectConflicts`)

| 场景           | ops/sec | 平均耗时 (ms) |
| -------------- | ------- | ------------- |
| 2 组, 无冲突   | 13,927  | 0.07          |
| 2 组, 部分冲突 | 10,949  | 0.09          |
| 2 组, 全部冲突 | 17,497  | 0.05          |
| 3 组, 有冲突   | 9,754   | 0.10          |
| 5 组, 有冲突   | 5,825   | 0.17          |

**大规模补丁 (每组 60 个补丁):**

| 场景      | ops/sec | 平均耗时 (ms) |
| --------- | ------- | ------------- |
| 无冲突    | 2,528   | 0.40          |
| 30 个冲突 | 2,320   | 0.43          |

---

### 冲突解决 (`resolveConflicts`)

| 场景           | ops/sec | 平均耗时 (μs) |
| -------------- | ------- | ------------- |
| 3 个冲突       | 652,499 | 1.5           |
| 10 个冲突      | 274,235 | 3.6           |
| 3 组冲突       | 451,954 | 2.2           |
| 自定义解决方案 | 471,492 | 2.1           |

---

### 验证功能

**validateJson:**

| 场景       | ops/sec | 平均耗时 (ms) |
| ---------- | ------- | ------------- |
| 小 (10项)  | 64,858  | 0.015         |
| 中 (100项) | 6,657   | 0.150         |
| 大 (500项) | 1,312   | 0.762         |
| 无效 JSON  | 88,356  | 0.011         |

**validatePatches:**

| 场景       | ops/sec   |
| ---------- | --------- |
| 10 个补丁  | 2,487,973 |
| 100 个补丁 | 413,011   |

---

## 扩展性分析

| 数据量 | 耗时 (ms) | 每项耗时 (μs) | 扩展因子 |
| ------ | --------- | ------------- | -------- |
| 10     | 0.09      | 9.0           | 1.00x    |
| 100    | 0.67      | 6.7           | 0.74x    |
| 500    | 3.01      | 6.0           | 0.67x    |

> [!TIP]
> 库在主要操作上均保持了 **O(n) 线性复杂度**，特别是在处理大规模数据和频繁补丁应用时表现出色。

---

## 运行基准测试

```bash
# 运行所有测试
pnpm vitest bench --run

# 运行特定类别
pnpm vitest bench --run benchmarks/generate/
pnpm vitest bench --run benchmarks/apply/
pnpm vitest bench --run benchmarks/detect/
pnpm vitest bench --run benchmarks/resolve/
pnpm vitest bench --run benchmarks/validate/
```

_测试环境: Linux, Node.js v22+_  
_更新日期: 2025-12-30_
